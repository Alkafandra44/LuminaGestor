<!-- filepath: c:\xampp2\htdocs\SystemDjango\gestion\templates\expedientes\show.html -->
{% extends "form_exp.html" %}
{% block contenido %}
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2>{{ title }}</h2>
      <form class="form-horizontal">
        <div class="card card-default">
          <div class="card-header">
            <h4 class="card-title">
              <i class="bi bi-eye"></i> Vista de Expediente
            </h4>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Título:</label>
              <input type="text" class="form-control" value="{{ expediente.title }}" disabled>
            </div>
            <div class="form-group">
              <label>Procedencia:</label>
              <input type="text" class="form-control" value="{{ expediente.procedencia }}" disabled>
            </div>
            <div class="form-group">
              <label>Fecha de Entrega:</label>
              <input type="text" class="form-control" value="{{ expediente.fecha_entrega }}" disabled>
            </div>
            <div class="form-group">
              <label>Clientes:</label>
              <input type="text" class="form-control" value="{% for c in expediente.clientes.all %}{{ c }}{% if not forloop.last %}, {% endif %}{% endfor %}" disabled>
            </div>
            <div class="form-group">
              <label>Clasificación:</label>
              <input type="text" class="form-control" value="{{ expediente.clasificacion }}" disabled>
            </div>
            <div class="form-group">
              <label>UEB/OBETS:</label>
              <input type="text" class="form-control" value="{{ expediente.ueb_obets }}" disabled>
            </div>
            <div class="form-group">
              <label>Reclamación:</label>
              <input type="text" class="form-control" value="{{ expediente.reclamacion }}" disabled>
            </div>
            <div class="form-group">
              <label>Resumen:</label>
              <textarea class="form-control" rows="3" disabled>{{ expediente.resumen }}</textarea>
            </div>
            <div class="form-group">
              <label>Archivos:</label>
              <ul>
                {% for archivo in archivos %}
                  <li>
                    <a href="{{ archivo.archivo.url }}" target="_blank">{{ archivo.nombre }}</a>
                  </li>
                {% empty %}
                  <li>No hay archivos adjuntos.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="form-group">
              <label>Estado:</label>
              <input type="text" class="form-control" value="{{ expediente.estado_expediente }}" disabled>
            </div>
            <div class="form-group">
              <label>Usuario:</label>
              <input type="text" class="form-control" value="{{ expediente.user.username }}" disabled>
            </div>
            <div class="form-group">
              <label>Fecha de creación:</label>
              <input type="text" class="form-control" value="{{ expediente.fecha_create }}" disabled>
            </div>
            <div class="form-group d-flex justify-content-between mt-3">
                <a href="{{ list_url }}" class="btn btn-outline-secondary">Volver</a>
                <div>
                  {% if perms.user.view_expediente %}
                      <button type="button" id="btnSolucionado" class="btn btn-success">Solucionado</button>
                      <button type="button" id="btnCorregir" class="btn btn-danger">Corregir</button>
                  {% endif %}
                </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
    function cambiarEstado(accion) {
        $.ajax({
            url: window.location.pathname,
            type: 'POST',
            data: {
                'action': accion,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: 'Estado actualizado correctamente',
                        icon: 'success'
                    }).then(() => {
                        // Recargar manteniendo la misma URL
                        window.location.href = window.location.href.split('?')[0];
                    });
                } else {
                    Swal.fire('Error', response.error || 'Ocurrió un error', 'error');
                }
                
                if (response.revision) {
                    // Actualizar visualmente el estado si se cambió a Revisión
                    $('input[value="' + expediente.estado_expediente + '"]')
                        .val('Revisión')
                        .closest('.form-group')
                        .find('input')
                        .val('Revisión');
                }
            },
            error: function() {
                Swal.fire('Error', 'Error en la conexión con el servidor', 'error');
            }
        });
    }

    $('#btnSolucionado').click(function() {
        cambiarEstado('solucionado');
    });

    $('#btnCorregir').click(function() {
        cambiarEstado('corregir');
    });
});
</script>
{% endblock %}
